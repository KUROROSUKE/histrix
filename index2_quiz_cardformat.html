<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>年表クイズ（カード出力: [正解][回答] タイトル）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f7fb; --fg:#111; --muted:#666; --border:#d9dbe3; --pri:#2346ff; --card:#fff;
    }
    *{box-sizing:border-box}
    body{font-family:sans-serif;margin:0;display:flex;flex-direction:column;min-height:100vh;padding-bottom:56px;background:var(--bg);color:var(--fg);}
    main{flex:1;overflow:auto;padding:16px;}
    #adminSection,#gameSection{max-width:960px;margin:0 auto;}
    nav{position:fixed;bottom:0;left:0;width:100%;height:56px;display:flex;background:#333;color:#fff;}
    nav button{flex:1;background:none;border:none;color:#fff;font-size:1rem;padding:12px 0;cursor:pointer;}
    nav button.active,nav button:hover{background:#555;}
    #controls{margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    #controls input,#controls button{font-size:1rem;padding:8px 12px;min-width:120px;box-sizing:border-box;}
    table{border-collapse:collapse;width:100%;background:var(--card);}
    th,td{border:1px solid var(--border);padding:6px 8px;text-align:center;}
    thead{background:#e9f1ff;}
    #board{display:flex;flex-direction:column;gap:10px;align-items:stretch;margin:16px 0;min-height:64px;}
    .card{padding:12px 16px;border:2px solid #333;border-radius:8px;background:#fff;text-align:left;font-weight:normal;position:relative;}
    .stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin:8px 0 12px;}
    .stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;box-shadow:0 1px 0 rgba(0,0,0,.02);}
    .stat .label{font-size:.85rem;color:var(--muted);}
    .stat .val{font-size:1.6rem;font-weight:800;margin-top:2px;}
    .qwrap{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;}
    .qtitle{font-weight:800;font-size:1.25rem;line-height:1.5;}
    .hint{color:var(--muted);font-size:.9rem;margin-top:6px;}
    .inputRow{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap;}
    .inputRow input, .inputRow button{font-size:1rem;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;}
    .inputRow button{cursor:pointer;color:#fff;background:var(--pri);border-color:#2740ff;}
    .inputRow button:hover{filter:brightness(0.98);}
    .muted{color:var(--muted);font-size:.9rem;}
  </style>
</head>
<body>
<main>
  <section id="adminSection">
    <h1>クイズ編集</h1>
    <div id="controls">
      <input id="question" placeholder="カードのテキスト">
      <input id="year" placeholder="年 (例: 1945)">
      <input id="month" placeholder="月 (空→1)">
      <input id="day" placeholder="日 (空→1)">
      <button id="addBtn">追加</button>

      <button id="saveBtn">保存</button>

      <button id="loadBtn">ファイル読込</button>
      <input type="file" id="loadFile" accept=".json,application/json" style="display:none;">

      <input id="loadUrl" style="min-width:320px;" value="https://kurorosuke.github.io/histrix/history.json" placeholder="JSONのURL">
      <button id="loadFromUrlBtn">URL読込</button>

      <button id="pasteBtn">貼り付け読込</button>
    </div>
    <textarea id="pasteBox" placeholder='ここにJSONを貼り付け → 「貼り付け反映」' style="width:100%;min-height:120px;display:none;"></textarea>
    <div style="display:flex;gap:8px;margin:8px 0;">
      <button id="applyPasteBtn" style="display:none;">貼り付け反映</button>
    </div>
    <table>
      <thead><tr><th>カード</th><th>日付</th><th>削除</th></tr></thead>
      <tbody id="questions_body"></tbody>
    </table>
  </section>

  <section id="gameSection" style="display:none;">
    <h1>年表クイズ</h1>

    <div class="stats">
      <div class="stat"><div class="label">n（回答数）</div><div class="val" id="n">0</div></div>
      <div class="stat"><div class="label">SSE（年²）</div><div class="val" id="sse">0</div></div>
      <div class="stat"><div class="label">MSE（年）</div><div class="val" id="mse">0</div></div>
      <div class="stat"><div class="label">閾値（日）</div><div class="val" id="threshold">36,525</div></div>
    </div>

    <div class="qwrap">
      <div id="qText" class="qtitle">—</div>
      <div class="hint">入力: YYYYMMDD または YYYY-M-D。全角可。7桁は月0埋め。年3桁はハイフン形式で左0埋め。</div>
      <div class="inputRow">
        <input id="answer" placeholder="例) 18891102" inputmode="numeric">
        <button id="submitBtn">回答</button>
        <span id="status" class="muted"></span>
      </div>
    </div>

    <div id="board"></div>
  </section>
</main>

<nav id="bottomNav">
  <button id="navGame">ゲーム開始</button>
  <button id="navAdmin" class="active">クイズ編集</button>
</nav>

<script>
/* ===== Utility (no regex /g) ===== */
function isDigit(ch){ return ch >= '0' && ch <= '9'; }
function stripNonDigits(s){ let out=''; for(const ch of String(s)) if(isDigit(ch)) out+=ch; return out; }
function pad2(n){ return String(n).padStart(2,'0'); }
function toHalfWidthDigits(s){
  let out=''; for(const ch of String(s)){ const code=ch.codePointAt(0);
    out += (code>=0xFF10 && code<=0xFF19) ? String.fromCharCode(code-0xFF10+0x30) : ch; }
  return out;
}
function normalizeValue(v){
  let s = stripNonDigits(v);
  if (s.length === 7) s = s.slice(0,4) + '0' + s.slice(4);
  if (s.length !== 8) return null;
  const y=+s.slice(0,4), m=+s.slice(4,6), d=+s.slice(6,8);
  if (m<1||m>12||d<1||d>31) return null;
  return s;
}
function ymd(dt){
  const y = dt.getUTCFullYear();
  const m = String(dt.getUTCMonth()+1).padStart(2,'0');
  const d = String(dt.getUTCDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}
function ymdJP(dt){
  const y = dt.getUTCFullYear();
  const m = String(dt.getUTCMonth()+1).padStart(2,'0');
  const d = String(dt.getUTCDate()).padStart(2,'0');
  return `${y}年${m}月${d}日`;
}
function daysDiffUTC(a,b){ return Math.round(Math.abs(a.getTime()-b.getTime())/86400000); }
function parseHyphenDate(str){
  const p = str.split('-'); if(p.length!==3) return null;
  const y=p[0], m=p[1], d=p[2];
  if(y.length<3||y.length>4||m.length<1||m.length>2||d.length<1||d.length>2) return null;
  const y4=y.padStart(4,'0'), m2=m.padStart(2,'0'), d2=d.padStart(2,'0');
  const yi=+y4, mi=+m2, di=+d2; if(mi<1||mi>12||di<1||di>31) return null;
  const dt = new Date(Date.UTC(yi, mi-1, di));
  if(dt.getUTCFullYear()!==yi || dt.getUTCMonth()+1!==mi || dt.getUTCDate()!==di) return null;
  return dt;
}
function parseFlexibleInput(input){
  if(!input) return null;
  let raw = toHalfWidthDigits(String(input).trim());
  if (raw.indexOf('-')>=0) return parseHyphenDate(raw);
  let digits = stripNonDigits(raw);
  if (digits.length===7) digits = digits.slice(0,4)+'0'+digits.slice(4);
  if (digits.length!==8) return null;
  const yi=+digits.slice(0,4), mi=+digits.slice(4,6), di=+digits.slice(6,8);
  if(mi<1||mi>12||di<1||di>31) return null;
  const dt=new Date(Date.UTC(yi,mi-1,di));
  if(dt.getUTCFullYear()!==yi || dt.getUTCMonth()+1!==mi || dt.getUTCDate()!==di) return null;
  return dt;
}
function fromItemToISO(x){
  const title = x && (x.title ?? x.text ?? x.event ?? x.name);
  const rawDate = x && (x.date ?? x.ymd ?? x.when ?? x.value);
  if (!title || !rawDate) return null;
  let s = String(rawDate).trim();
  s = s.split('/').join('-');
  const digits = stripNonDigits(s);
  if (digits.length === 8) s = digits.slice(0,4)+'-'+digits.slice(4,6)+'-'+digits.slice(6,8);
  const parts = s.split('-'); if(parts.length!==3) return null;
  if(parts[0].length!==4 || parts[1].length!==2 || parts[2].length!==2) return null;
  return { title, date: s };
}

/* ===== State ===== */
let Questions = [];
let deck = [];
let current = null;
let n=0;
let sseYears=0; // SSE in years^2
const THRESHOLD_DAYS = 36525;

/* ===== DOM ===== */
const tableBody = document.getElementById("questions_body");
const questionTag = document.getElementById("question");
const yearTag = document.getElementById("year");
const monthTag = document.getElementById("month");
const dayTag = document.getElementById("day");
const addBtn = document.getElementById("addBtn");
const saveBtn = document.getElementById("saveBtn");
const loadBtn = document.getElementById("loadBtn");
const loadFile = document.getElementById("loadFile");
const loadUrl = document.getElementById("loadUrl");
const loadFromUrlBtn = document.getElementById("loadFromUrlBtn");
const pasteBtn = document.getElementById("pasteBtn");
const pasteBox = document.getElementById("pasteBox");
const applyPasteBtn = document.getElementById("applyPasteBtn");

const navBar = document.getElementById("bottomNav");
const navGame = document.getElementById("navGame");
const navAdmin = document.getElementById("navAdmin");
const adminSection = document.getElementById("adminSection");
const gameSection = document.getElementById("gameSection");

const qText = document.getElementById("qText");
const answerEl = document.getElementById("answer");
const submitBtn = document.getElementById("submitBtn");
const boardDiv = document.getElementById("board");
const statusEl = document.getElementById("status");
const nEl = document.getElementById("n");
const sseEl = document.getElementById("sse");
const mseEl = document.getElementById("mse");
const thresholdEl = document.getElementById("threshold");

/* ===== Navigation ===== */
navGame.onclick = () => switchSection('game');
navAdmin.onclick = () => switchSection('admin');
loadBtn.onclick = () => loadFile.click();

function switchSection(target){
  if(target === 'admin'){
    adminSection.style.display = 'block';
    gameSection.style.display = 'none';
    navAdmin.classList.add('active');
    navGame.classList.remove('active');
    navBar.style.display = 'flex';
    updateQuestionsTable();
  } else {
    adminSection.style.display = 'none';
    gameSection.style.display = 'block';
    navAdmin.classList.remove('active');
    navGame.classList.add('active');
    startGame();
  }
}

/* ===== Admin ===== */
function sanitize(arr){
  if (!Array.isArray(arr)) return [];
  const out = [];
  for (const item of arr) {
    const norm = fromItemToISO(item);
    if (!norm) continue;
    out.push({ text: norm.title, value: norm.date.split('-').join('') });
  }
  out.sort((a,b)=> a.value.localeCompare(b.value));
  return out;
}

function updateQuestionsTable(){
  tableBody.innerHTML = "";
  for (let i=0;i<Questions.length;i++){
    const q = Questions[i];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${q.text}</td>
      <td>${q.value.slice(0,4)}年${q.value.slice(4,6)}月${q.value.slice(6,8)}日</td>
      <td><span style="color:red;cursor:pointer;" onclick="deleteQuestion(${i})">削除</span></td>`;
    tableBody.appendChild(tr);
  }
}
window.deleteQuestion = function(index){
  if (confirm("削除しますか？")) {
    Questions.splice(index, 1);
    updateQuestionsTable();
  }
};

addBtn.onclick = () => {
  const q = questionTag.value.trim();
  const y = parseInt(yearTag.value.trim(), 10);
  const m = monthTag.value.trim()==="" ? 1 : parseInt(monthTag.value.trim(), 10);
  const d = dayTag.value.trim()==="" ? 1 : parseInt(dayTag.value.trim(), 10);
  if(!q || isNaN(y) || isNaN(m) || isNaN(d)){ alert("正しい入力をしてください"); return; }
  if(m<1 || m>12 || d<1 || d>31){ alert("月日は範囲外"); return; }
  const value = String(y).padStart(4,"0")+String(m).padStart(2,"0")+String(d).padStart(2,"0");
  const valNormalized = normalizeValue(value);
  if(valNormalized===null){ alert("日付形式エラー"); return; }
  Questions.push({text:q, value:valNormalized});
  questionTag.value = yearTag.value = monthTag.value = dayTag.value = "";
  updateQuestionsTable();
};

saveBtn.onclick = () => {
  const blob = new Blob([JSON.stringify(Questions, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "quiz_data.json";
  a.click();
  URL.revokeObjectURL(url);
};

loadFile.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      Questions = sanitize(data);
      alert(`読み込み完了: ${Questions.length}件`);
      updateQuestionsTable();
    } catch (e) {
      alert("JSON読み込み失敗: " + e.message);
    }
  };
  reader.readAsText(file);
};

loadFromUrlBtn.onclick = async () => {
  const url = loadUrl.value.trim();
  if (!url) { alert("URLを入力してください"); return; }
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    Questions = sanitize(data);
    alert(`URL読込: ${Questions.length}件`);
    updateQuestionsTable();
  }catch(e){
    alert('URL読込失敗: ' + e.message + '\\nヒント: ローカルfile://で開くとCORSでブロックされる場合があります。サーバー経由で開くと成功します。');
  }
};

pasteBtn.onclick = () => {
  const show = pasteBox.style.display === 'none';
  pasteBox.style.display = show ? 'block' : 'none';
  applyPasteBtn.style.display = show ? 'inline-block' : 'none';
};
applyPasteBtn.onclick = () => {
  try{
    const data = JSON.parse(pasteBox.value);
    Questions = sanitize(data);
    alert(`貼り付け読込: ${Questions.length}件`);
    updateQuestionsTable();
  }catch(e){
    alert('JSONエラー: ' + e.message);
  }
};

/* ===== Game: SSE years^2, MSE years ===== */
function startGame(){
  if(Questions.length < 1){
    alert("問題データを用意してください");
    switchSection('admin');
    return;
  }
  n=0; sseYears=0; current=null;
  updateStats();
  statusEl.textContent = "";
  boardDiv.innerHTML = "";
  navBar.style.display = 'none';
  deck = Questions.map((_,i)=>i).sort(()=>Math.random()-0.5);
  askNext();
}
function updateStats(){
  nEl.textContent = String(n);
  sseEl.textContent = (sseYears).toFixed(3);
  mseEl.textContent = n>0 ? Math.sqrt(sseYears/n).toFixed(3) : '0';
  thresholdEl.textContent = (THRESHOLD_DAYS).toLocaleString('ja-JP');
}
function askNext(){
  if(deck.length===0){
    statusEl.textContent = "全問終了";
    navBar.style.display = 'flex';
    updateQuestionsTable();
    return;
  }
  const idx = deck.pop();
  current = idx;
  const q = Questions[idx];
  qText.textContent = q.text;
  answerEl.value = "";
  answerEl.focus();
}
function onSubmit(){
  if(current===null) return;
  const q = Questions[current];
  const trueDigits = q.value;
  const trueDt = new Date(Date.UTC(+trueDigits.slice(0,4), +trueDigits.slice(4,6)-1, +trueDigits.slice(6,8)));
  const inDt = parseFlexibleInput(answerEl.value);
  if(!inDt){ statusEl.textContent = "入力エラー: YYYYMMDD または YYYY-M-D（全角OK、7桁は月0埋め）"; return; }
  const diffDays = daysDiffUTC(inDt, trueDt);
  const diffYears = diffDays / 365.25;
  n += 1;
  sseYears += diffYears * diffYears;
  updateStats();
  appendTimelineCard(q, trueDt, inDt);
  if(diffDays > THRESHOLD_DAYS){
    statusEl.textContent = `終了: 閾値 36,525 日を超過（約 ${diffYears.toFixed(2)} 年）`;
    current = null; navBar.style.display = 'flex'; updateQuestionsTable(); return;
  }
  statusEl.textContent = `次へ。`;
  current = null; askNext();
}
function appendTimelineCard(q, trueDt, userDt){
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.t = String(trueDt.getTime());
  const left = ymdJP(trueDt);
  const right = ymdJP(userDt);
  card.textContent = `[${left}][${right}] ${q.text}`;
  // Insert by chronological order (true date)
  const items = Array.from(boardDiv.children);
  let inserted = false;
  for(let i=0;i<items.length;i++){
    const ti = Number(items[i].dataset.t||0);
    if(trueDt.getTime() < ti){ boardDiv.insertBefore(card, items[i]); inserted = true; break; }
  }
  if(!inserted) boardDiv.appendChild(card);
}

submitBtn.onclick = onSubmit;
answerEl.addEventListener('keydown', e => { if(e.key==='Enter') onSubmit(); });
</script>
</body>
</html>
